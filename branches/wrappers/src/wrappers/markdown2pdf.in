#!/bin/sh -e

REQUIRED=markdown2latex

### common.sh

### tempdir.sh

if ! markdown2latex "$@" -s -d >$THIS_TEMPDIR/output.tex 2>$THIS_TEMPDIR/log; then
    cat $THIS_TEMPDIR/log | sed -e 's/markdown2latex/markdown2pdf/g'
    exit 1
fi

outfile="$(sed -ne '/^OUTPUT=/ s/^OUTPUT=\(.*\)/\1/p' $THIS_TEMPDIR/log)"
if [ -f "$outfile" ]; then
    mv "$outfile" $THIS_TEMPDIR/output.tex
fi
infiles="$(sed -ne '/^INPUT=/ s/^INPUT=\(.*\)/\1/p' $THIS_TEMPDIR/LOG)"
infile="${infiles%%:*}"
infilebase="${infile%.*}"
defaultdest="${infilebase:-stdin}.pdf"
destname="${outfile:-$defaultdest}"

(
    cd $THIS_TEMPDIR
    if ! pdflatex -interaction=batchmode output.tex >/dev/null 2>&1; then
        err "LaTeX errors:"
        cat output.log | sed -ne '/^!/,/^ *$/p' >&2
        if grep -q "File \`ucs.sty' not found" output.log; then
            err "Please install the 'unicode' package from ctan.org."
        fi
        exit 1
    fi
)

is_target_exists=
if [ -f "$destname" ]; then
    is_target_exists=1
    mv "$destname" "$destname~" 
fi

mv -f $THIS_TEMPDIR/output.pdf "$destname"

errn "Created $destname"
[ -z "$is_target_exists" ] || {
    errn " (previous file has been backed up as $destname~)"
}
err .
