#!/bin/sh
# converts markdown to latex, then uses latex to make a PDF

REQUIRED=pdflatex

### common.sh

### getopts.sh

if [ -z "$outfile" ]; then
    if [ -n "$infile" ]; then
        outfile="${infile%.*}.pdf"
    else
        outfile='stdin.pdf' # input is STDIN, since no argument given
    fi
fi

BASE=${outfile##*/}
BASE=${BASE%.*}

set -e

TEMP=${TMPDIR-/tmp}/markdown2pdf.$$
trap "status=$?; rm -rf $TEMP; exit $status" INT QUIT TERM EXIT
mkdir -p $TEMP

safein "$infile" | \
pandoc $PANDOC_OPTS -w latex -s | \
safeout >$TEMP/$BASE.tex && (
    cd $TEMP
    if ! pdflatex -interaction=batchmode $BASE.tex >/dev/null 2>&1; then
        echo >&2 "LaTeX errors:"
        sed -ne '/^!/,/^ *$/p' $BASE.log >&2
        exit 1
    fi
) || exit $?

safeout "$TEMP/$BASE.pdf" "$outfile"
