#!/bin/sh
# converts markdown to latex, then uses latex to make a PDF

REQUIRED=pdflatex
EXTENSION=.pdf

### common.sh

### getopts.sh

### postopts.sh

if [ -z "$outfile" ]; then
    if [ -n "$1" ]; then
        outfile="${1%.*}$EXTENSION"
    else
        outfile="stdin$EXTENSION" # input is STDIN, since no argument given
    fi
fi

set -e

# We should use a filename without white spaces for pdflatex.
TEXNAME=$THIS

ensure_tempdir

safein "$@" |
pandoc $PANDOC_OPTS -w latex -s | safeout >$THIS_TEMPDIR/$TEXNAME.tex && (
    cd $THIS_TEMPDIR
    if ! pdflatex -interaction=batchmode $TEXNAME.tex >/dev/null 2>&1; then
        err "LaTeX errors:"
        sed -ne '/^!/,/^ *$/p' $TEXNAME.log >&2
        ucs_errors=$(grep "File \`ucs.sty' not found" $TEXNAME.log)
        if [ -n $ucs_errors ]; then
            err "Please install the 'unicode' package from ctan.org."
        fi
        exit 1
    fi
) && safeout $THIS_TEMPDIR/$TEXNAME.pdf "$outfile"
