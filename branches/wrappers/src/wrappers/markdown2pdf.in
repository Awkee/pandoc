#!/bin/sh
# converts markdown to latex, then uses latex to make a PDF

REQUIRED=pdflatex
EXTENSION=.pdf

### common.sh

### getopts.sh

### postopts.sh

# We should use a filename without white spaces for pdflatex.
TEXNAME=$THIS

set -e

TEMP=${TMPDIR-/tmp}/markdown2pdf.$$
trap "exitcode=$?; rm -rf $TEMP; exit $exitcode" INT QUIT TERM EXIT
mkdir -p $TEMP

safein "$@" | pandoc $PANDOC_OPTS -w latex -s | safeout >$TEMP/$TEXNAME.tex && (
    cd $TEMP
    if ! pdflatex -interaction=batchmode $TEXNAME.tex >/dev/null 2>&1; then
        echo >&2 "LaTeX errors:"
        sed -ne '/^!/,/^ *$/p' $TEXNAME.log >&2
        exit 1
    fi
) && safeout $TEMP/$TEXNAME.pdf "$outfile"
