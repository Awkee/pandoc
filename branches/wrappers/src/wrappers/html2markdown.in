#!/bin/sh -e
# converts html to markdown
# uses an available program to fetch URL and tidy to normalize it first

REQUIRED=tidy
SINGLE_FILE_INPUT=yes

### common.sh

grab_url_with () {
    url="${1:?internal error: grab_url_with: url required}"

    shift
    cmdline="$@"

    prog=
    prog_opts=
    if [ -n "$cmdline" ]; then
	set -- $cmdline
	prog=$1
	shift
	prog_opts="$@"
    fi

    if [ -z "$prog" ]; then
	# Locate a sensible web grabber (note the order).
	for p in wget lynx w3m curl links w3c; do
		if pathfind $p; then
		    prog=$p
		    break
		fi
	done

	[ -n "$prog" ] || {
            errn "$THIS: Couldn't find a program to fetch the URL "
	    err "(e.g. wget, w3m, lynx, w3c, or curl)."
	    return 1
	}
    else
	pathfind "$prog" || {
	    err "$THIS: No such web grabber '$prog' found; aborting."
	    return 1
	}
    fi

    # Setup proper base options for known grabbers.
    base_opts=
    case "$prog" in
    wget)  base_opts="-O-" ;;
    lynx)  base_opts="-source" ;;
    w3m)   base_opts="-dump_source" ;;
    curl)  base_opts="" ;;
    links) base_opts="-source" ;;
    w3c)   base_opts="-n -get" ;;
    *)     err "$THIS: unhandled web grabber '$prog'.  Hope it succeeds."
    esac

    set -- $base_opts $prog_opts

    $prog "$@" "$url"; exitcode=$?

    err "$THIS: '$prog $@ $url' invoked."
    return $exitcode
}

SYNOPSIS="[-o output_file] [-g grabber_command] [-n] [-h|?] [input_file|url]"

grabber=
outfile=
nograb=
while getopts g:o:nh opt; do
    case $opt in
    g) grabber="$OPTARG" ;;
    o) outfile="$OPTARG" ;;
    n) nograb=1 ;;
    ?|h) usage "$SYNOPSIS"; exit 2 ;;
    esac
done

shift $(($OPTIND - 1))

### postopts.sh

if [ -n "$infile" ] && ! [ -f "$infile" ]; then
    if [ -n "$nograb" ]; then
	err "'$infile' not found; refusing to treat input as URL."
        exit 1
    fi

    # Treat given argument as an URL.
    err "Attempting to fetch file from '$infile'..."

    # We need a temporary directory.
    ensure_tempdir

    grabber_out=$THIS_TEMPDIR/grabber.out
    grabber_log=$THIS_TEMPDIR/grabber.log
    if ! grab_url_with "$infile" "$grabber" 1>$grabber_out \
                                            2>$grabber_log; then
        errn "grab_url_with failed"
        if [ -f $grabber_log ]; then
            err " with the following error log."
            err
            cat >&2 $grabber_log
        else
            err .
        fi
        exit 1
    fi

    # To be on the safe side detect bogus output.
    infile=$grabber_out
    if ! [ -f $infile ] || [ -z "$(tr -d [:space:] <$infile)" ]; then
        err "Empty content returned from grabber."
        exit 0
    fi
fi

safein "$infile" | tidy -utf8 2>/dev/null |
pandoc $PANDOC_OPTS -r html -w markdown -s | safeout "$outfile"
